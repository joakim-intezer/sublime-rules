name: "Attachment: Any HTML file (unsolicited)"
description: |
  Potential HTML smuggling attacks in unsolicited messages.
  Use if passing HTML files is not normal behavior in your environment.
  This rule may be expanded to inspect HTML attachments for suspicious code.
references:
  - "https://ired.team/offensive-security/defense-evasion/file-smuggling-with-html-and-javascript"
  - "https://sandbox.sublimesecurity.com?id=106315e9-166a-4e0f-946e-88ff6fd5f9fd"
type: "rule"
severity: "low"
source: |
  type.inbound
  and any(attachments,
          (.file_extension in~ ('htm', 'html') or .file_type == "html")
          
          // negate cisco secure spawned HTML
          and not regex.match(file.parse_html(.).raw,
                              '<!-- saved from url=.{0,6}https://res.cisco.com:443 -->.*'
          )
  )
  and (
    not profile.by_sender().any_false_positives
    and not profile.by_sender().solicited
  )

  // negate highly trusted sender domains unless they fail DMARC authentication
  and (
    (
      sender.email.domain.root_domain in $high_trust_sender_root_domains
      and (
        any(distinct(headers.hops, .authentication_results.dmarc is not null),
            strings.ilike(.authentication_results.dmarc, "*fail")
        )
      )
    )
    or sender.email.domain.root_domain not in $high_trust_sender_root_domains
  )

  // Negating IPHMX.com used in a secure message delivery capacity 
  and not strings.ends_with(headers.message_id, ".iphmx.com>")

  // exclude Proofpoint encryption emails
  and any(headers.hops,
          .index == 0
          and not any(.fields,
                      strings.contains(.value,
                                      'multipart/mixed; boundary="PROOFPOINT_BOUNDARY_1"'
                      )
          )
  )

tags:
  - "Attack surface reduction"
tactics_and_techniques:
  - "HTML smuggling"
detection_methods:
  - "File analysis"
  - "HTML analysis"
  - "Sender analysis"
id: "ef36763f-917d-5338-b1ac-84047334dce8"
