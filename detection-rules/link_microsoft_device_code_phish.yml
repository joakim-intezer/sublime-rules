name: "Microsoft Device Code Phishing"
description: |
  An attacker may generate a user code and send it to a target mailbox. With an appropriate lure, the targeted user may action the device code login and provide an attacker with the means to take over their account.

  This rule looks for the presence of the Microsoft device login portal link, as well as mentions of 'device code' or a 9 character alphanumeric device code value.
type: "rule"
authors:
  - twitter: "ajpc500"
references:
  - "https://aadinternals.com/post/phishing/"
  - "https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html"
  - "https://www.inversecos.com/2022/12/how-to-detect-malicious-oauth-device.html"
severity: "medium"
source: "type.inbound\n\n// Not from MS as the device code will be generated and sent by the attacker\nand sender.email.domain.root_domain not in~ (\"microsoft.com\", \"microsoftonline.com\")\n\n// Link to the device code MS pages\nand any(body.links,\n        (\n          .href_url.url == \"https://microsoft.com/devicelogin\"\n          or .href_url.url == \"https://login.microsoftonline.com/common/oauth2/deviceauth\"\n        )\n)\n\n// Body text references device codes\nand (\n  strings.icontains(body.html.display_text, \"device code\")\n  or \n  // A nine character string containing a combination of letters and characters\n  regex.icontains(body.html.display_text, '[\\W]([A-Z0-9]{9})[\\W]')\n)\n\n// Unsolicited\nand (\n  not profile.by_sender().solicited\n  or (\n    profile.by_sender().any_messages_malicious_or_spam\n    and not profile.by_sender().any_false_positives\n  )\n)\n"
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Impersonation: Brand"
  - "Social engineering"
detection_methods:
  - "Content analysis"
  - "Sender analysis"
  - "URL analysis"
id: "61f3ae67-c05c-506f-bbfe-764108a40974"
testing_pr: 815
testing_sha: aed114f25899ab2d1ff2b5519c78aa177a48fa26
