name: "Attachment: HTML smuggling with auto-downloaded file"
description: |
  HTML attachments containing files that are automatically downloaded with Javascript.
references:
  - "https://delivr.to/payloads?id=40f2f908-b7ea-4dc8-9b72-4280c9005fdd"
type: "rule"
severity: "high"
source: "type.inbound\nand any(attachments,\n    (\n        .file_extension in~ (\"html\", \"htm\", \"shtml\", \"dhtml\") or\n        .file_extension in~ $file_extensions_common_archives or\n        .file_type == \"html\"\n    )\n    and any(file.explode(.),\n        any(.scan.javascript.identifiers, strings.ilike(., 'click'))\n        and any(.scan.javascript.identifiers, strings.ilike(., 'addEventListener'))\n        and (\n            length(filter(.scan.javascript.identifiers, strings.like (., \"document\", \"write\", \"atob\"))) == 3\n            // usage: document['write'](atob)\n            or any(.scan.strings.strings, strings.ilike(., \"*document*write*atob*\"))\n            // usage: some_var = atob();\n            or any(.scan.strings.strings, strings.ilike(., \"*=*atob*;\"))\n            // usage: obfuscating \"atob\"\n            or any(.scan.javascript.identifiers, strings.ilike(., '*ato\\u0062*'))\n            // usage: document.head.insertAdjacentHTML(\"beforeend\", atob(...\n            or \n                any(.scan.strings.strings, strings.ilike(.,\n                    \"*document*write*atob*\",\n                    \"*document*insertAdjacentHTML*atob*\"))\n        )\n    )\n)\n"
tags:
  - "HTML smuggling"
  - "Suspicious attachment"
testing_pr: 487
testing_sha: 2a68125dc75513a7d1a331aaeda92a0d350881cc
