name: "Attachment: EML file contains HTML attachment with login portal indicators"
description: |
  Attached EML file contains an HTML attachment with suspicious login indicators. Known credential theft technique.
references:
type: "rule"
severity: "high"
source: "type.inbound\n// exclude bounce backs & read receipts\nand not strings.like(sender.email.local_part, \"*postmaster*\", \"*mailer-daemon*\", \"*administrator*\")\nand not regex.icontains(subject.subject, \"^(undeliverable|read:)\")\nand not any(attachments, .content_type == \"message/delivery-status\")\n// if the \"References\" is in the body of the message, it's probably a bounce\nand not any(headers.references,\n    strings.contains(body.html.display_text, .)\n)\nand any(attachments, .content_type == \"message/rfc822\"\n    and any(file.explode(.),\n        (\n          // suspicious strings found in javascript\n          length(filter(.scan.javascript.strings, strings.ilike(.,\n              \"*password*\", \"*username*\", \"*login-form*\", \"*email-form*\", \"*Incorrect password. Please try again.*\", \"*Password Incomplete, please try again*\"\n          ))) >= 3 or \n          (\n              // suspicious strings found outside of javascript, but binexplode'd file still of HTML type\n              .flavors.mime in~ (\"text/html\", \"text/plain\") and \n              length(filter(.scan.strings.strings, strings.ilike(.,\n                  \"*password*\", \"*username*\", \"*login-form*\", \"*email-form*\", \"*Incorrect password. Please try again.*\", \"*Password Incomplete, please try again*\"\n              ))) >= 3\n          )\n      ) or \n      //Known phishing obfuscation\n      (\n          length(\n              filter(\n                  .scan.strings.strings, strings.ilike(.,\n                      //Enter password  \n                      \"*&#69;&#110;&#116;&#101;&#114;&#32;&#112;&#97;&#115;&#115;&#119;&#111;&#114;&#100*\",\n                      //Forgotten my password\n                      \"*&#70;&#111;&#114;&#103;&#111;&#116;&#116;&#101;&#110;&#32;&#109;&#121;&#32;&#112;&#97;&#115;&#115;&#119;&#111;&#114;&#100*\",\n                      //Sign in\n                      \"*&#83;&#105;&#103;&#110;&#32;&#105;&#110*\"\n                  )\n              )\n          ) >= 2\n      )\n    )\n)\n"
tags:
  - "Suspicious attachment"
  - "HTML smuggling"
  - "Credential phishing"
testing_pr: 541
testing_sha: 445abc2e4fdce919ac027d5195089e3bbcbc5bc3
