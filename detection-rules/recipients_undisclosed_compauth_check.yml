name: "Suspicious Recipients pattern with no Compauth pass and suspicious content"
description: "Detects messages with undisclosed recipients (likely all bcc), where the Compauth verdict is not 'pass', and ML has identified suspicious language or credential phishing links."
type: "rule"
severity: "medium"
source: "type.inbound\nand (\n    length(recipients.to) == 0\n    or all(recipients.to, .display_name == \"Undisclosed recipients\")\n)\nand length(recipients.cc) == 0\nand length(recipients.bcc) == 0\nand 2 of (\n    (\n        any(headers.hops,\n           .authentication_results.compauth.verdict is not null\n           and .authentication_results.compauth.verdict not in (\"pass\", \"softpass\")\n        )\n    ),\n    (\n        any(ml.nlu_classifier(body.current_thread.text).intents, \n            .name in (\"bec\", \"cred_theft\")\n            and .confidence == \"high\"\n        )\n    ),\n    (\n        any(body.links, \n            any([beta.linkanalysis(.)],\n            .credphish.disposition == \"phishing\"\n            and .credphish.confidence in (\"high\")\n            )   \n        )\n    )\n)\n"
tags:
  - "Suspicious sender"
  - "Suspicious headers"
  - "Natural Language Understanding"
  - "Machine Learning"
id: "34fb65f6-03e8-5752-b602-4f294172b5db"
testing_pr: 615
testing_sha: 894b9d3638379502d7a84ba147714dd213e0f594
