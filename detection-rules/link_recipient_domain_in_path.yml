name: "Link: Recipient Domain in URL Path"
description: "This rule detects URL paths which contain the recipient SLD multiple times. This has been observed in multiple credential phishing campaigns with MFA enrollment themed lures."
type: "rule"
severity: "high"
source: "type.inbound\n// \nand not profile.by_sender().solicited\n// not high trust sender domains\nand (\n  (\n    sender.email.domain.root_domain in $high_trust_sender_root_domains\n    and not headers.auth_summary.dmarc.pass\n  )\n  or sender.email.domain.root_domain not in $high_trust_sender_root_domains\n)\nand\n// any of the body links, contain the recipient domain repeating multiple times in a link path\nany(\n    // make a list of distinct email slds\n    distinct(map(recipients.to, .email.domain.sld)), \n    // take the list of slds and cat it into a string of /sld/sld/ and search for it in links\n    any(body.links, strings.icontains(.href_url.path, strings.concat(\"/\", .., \"/\", .., \"/\")))\n)\n"
attack_types:
  - "Credential Phishing"
tactics_and_techniques:
  - "Lookalike domain"
detection_methods:
  - "Header analysis"
  - "Sender analysis"
  - "URL analysis"
id: "de08731f-5fce-56bc-91b3-53b40d99278e"
testing_pr: 1669
testing_sha: c7e4d4dfc17c75df4730de1cbd85bf244c93bcaa
