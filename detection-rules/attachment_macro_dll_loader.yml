name: "Attachment: Archive contains DLL-loading macro"
description: |
  An attacker could send a trusted and signed document that references an untrusted DLL file, which will be loaded by the signed document.
references:
  - "https://outflank.nl/blog/2023/04/25/so-you-think-you-can-block-macros"
type: "rule"
severity: "high"
source: "type.inbound \nand any(attachments, .file_extension == \"zip\"\n       and (any(file.explode(.),\n            .scan.zip.encrypted == false\n            // zip contains a dll file\n            and any(.scan.zip.all_paths, strings.icontains(., \"dll\")))\n        and any(file.explode(.),\n            // macro references a dll file\n            any(.flavors.yara, strings.like(., \"vb_file\"))\n            and any(.scan.strings.strings, strings.icontains(., \"dll\"))\n           )\n       )\n       or any(file.explode(.), // fallback for encrypted zips\n           .scan.zip.encrypted == true\n           and any(.scan.zip.all_paths, any($file_extensions_macros, strings.icontains(.., .)))\n           // zip contains a dll file\n           and any(.scan.zip.all_paths, strings.icontains(., \"dll\"))\n       )\nor any(attachments, .file_extension in~ $file_extensions_common_archives\n    and any(file.explode(.),\n        any(.flavors.yara, strings.like(., \"vb_file\"))\n        and any(.scan.strings.strings, strings.ilike(., \"*Lib*.dll*\"))\n    )\n    and any(file.explode(.),\n        strings.ilike(.file_extension, \"dll\")\n        )\n    )\n)\n"
tags:
  - "Suspicious attachment"
  - "Office exploit"
  - "Macros"
testing_pr: 388
testing_sha: 59b623b6c726e9e12b35fe8f6ff6b12d9fa639d1
