name: "Attachment: HTML file with reference to recipient and suspicious patterns"
description: |
  Attached HTML file contains references to the recipients email address, indicative of credential phishing, and suspicious Javascript patterns.
type: "rule"
severity: "high"
source: "type.inbound \nand any(attachments, \n    (\n        .content_type == \"text/html\"\n        or .file_extension in~ (\"html\", \"htm\", \"shtml\", \"dhtml\")\n        or .file_type == \"html\"\n    )\n    and any(file.explode(.), .flavors.mime in~ (\"text/html\", \"text/plain\")\n        and any(recipients.to, any(..scan.strings.strings, strings.icontains(., ..email.email)))\n    )\n    and any(file.explode(.),\n        (\n            any(.flavors.yara, . == \"javascript_file\")\n            // common indicator of HTML smuggling\n            and length(filter(.scan.javascript.identifiers, strings.ilike(., \"_0x*\"))) > 50\n        )\n        or\n        (   \n            // javascript that doesn't get pulled out properly\n            .flavors.mime == \"text/plain\" and strings.ilike(.file_name, \"script*\")\n            // common indicator of HTML smuggling\n            and length(filter(.scan.strings.strings, regex.imatch(., \".*_0x.*\"))) > 50\n        )\n    )\n)\n"
tags:
  - "HTML smuggling"
  - "Suspicious attachments"
  - "Credential phishing"
testing_pr: 524
testing_sha: 7f1c5b16ae7b53880c4eb677ccb637537e828b5c
