name: "Brand Impersonation: Coinbase with suspicious links"
description: |
  Detects messages impersonating Coinbase with low reputation or url shortened links.
type: "rule"
severity: "medium"
source: "type.inbound\nand sender.email.domain.root_domain != \"coinbase.com\"\n\n// more than 0 less than 5 links\nand 0 < length(body.links) < 5 \n\n// none of the links are to coinbase.com\nand all(body.links, .href_url.domain.root_domain != \"coinbase.com\")\n\n// low rep or url shortened links found\nand any(body.links, \n    .href_url.domain.domain in $url_shorteners\n    \n    // exempting legitimate Google Maps shortener\n    and not strings.ilike(.href_url.url, \"http?://goo.gl/maps*\")\n    or \n    (\n          .href_url.domain.domain not in $tranco_1m or\n          .href_url.domain.domain in $free_file_hosts or\n          .href_url.domain.root_domain in $free_subdomain_hosts or\n          .href_url.domain.domain in $url_shorteners or\n\n          // mass mailer link, masks the actual URL\n          .href_url.domain.root_domain in (\n              \"hubspotlinks.com\",\n              \"mandrillapp.com\",\n              \"sendgrid.net\",\n          )\n    )\n)\n// Coinbase logo\nand (\n    any(attachments,\n        .file_type in ('png', 'jpeg', 'jpg', 'bmp')\n        and any(ml.logo_detect(.).brands, .name == \"Coinbase\")\n        )\n    or any(ml.logo_detect(beta.message_screenshot()).brands,\n        .name == \"Coinbase\")\n)\n"
tags:
  - "Brand impersonation"
  - "Suspicious link"
  - "Computer Vision"
testing_pr: 570
testing_sha: d25439bbe9064d5b81c2a97b47935bc056b886f0
