name: "Attachment: HTML file with excessive padding and suspicious patterns"
description: |
  Attached HTML file contains excessive line breaks and suspicious Javascript patterns.
type: "rule"
severity: "high"
source: "type.inbound \nand any(attachments, \n    (\n        .content_type == \"text/html\"\n        or .file_extension in~ (\"html\", \"htm\", \"shtml\", \"dhtml\")\n        or .file_type == \"html\"\n    )\n    // excessive line breaks\n    and regex.icontains(.raw, \"^(DQoNCg0K){150,}\")\n    and any(file.explode(.), \n        (\n            any(.flavors.yara, . == \"javascript_file\")\n            // common indicator of HTML smuggling\n            and length(filter(.scan.javascript.identifiers, strings.ilike(., \"_0x*\"))) > 50\n        )\n        or\n        (   \n            // javascript that doesn't get pulled out properly\n            .flavors.mime == \"text/plain\" and strings.ilike(.file_name, \"script*\")\n            // common indicator of HTML smuggling\n            and length(filter(.scan.strings.strings, regex.imatch(., \".*_0x.*\"))) > 50\n        )\n    )\n)\n"
tags:
  - "HTML smuggling"
  - "Suspicious attachment"
testing_pr: 522
testing_sha: 5ed69fa0ea73af2e859a2e89b41a1124618ce3a2
