name: "Brand impersonation: Microsoft (QR code)"
description: |
  Detects messages using Microsoft image based lures, referencing or including a QR code from an Unsolicited sender. These messages often lead users to phishing sites or initiate unwanted downloads.
type: "rule"
severity: "medium"
source: "type.inbound\nand any(attachments, \n    .file_type in~ ('bmp', 'png', 'jpg', 'jpeg')\n    and any(ml.logo_detect(.).brands, .name in~ (\"Microsoft\", \"Office365\"))\n)\nand any(attachments,\n    .file_type in~ ('bmp', 'png', 'jpg', 'jpeg')\n    and (\n        any(file.explode(.),\n            any(.scan.strings.strings, regex.icontains(.,  'scan|camera'))   \n            and any(.scan.strings.strings, regex.icontains(.,  '\\bQR\\b|Q\\.R\\.|barcode'))\n        )\n        or (\n            any(file.explode(.), .scan.qr.type == \"url\"\n                // recipient email address is present in the URL, a common tactic used in credential phishing attacks \n                and any(recipients.to, strings.icontains(..scan.qr.data, .email.email))\n            )\n        )   \n    )\n)\nand (\n    not any(headers.hops,\n        .authentication_results.compauth.verdict is not null\n        and .authentication_results.compauth.verdict == \"pass\"\n        and sender.email.domain.domain == \"microsoft.com\"\n    )\n)\n// unsolicited\nand (\n    (\n        sender.email.domain.root_domain in $free_email_providers\n        and sender.email.email not in $recipient_emails\n    )\n    or (\n        sender.email.domain.root_domain not in $free_email_providers\n        and sender.email.domain.domain not in $recipient_domains\n    )\n)\n"
tags:
  - "Suspicious attachment"
  - "Brand impersonation"
  - "QR code"
testing_pr: 578
testing_sha: 6c5e3defe8779b0acce4646ffc28f421b8f627ed
