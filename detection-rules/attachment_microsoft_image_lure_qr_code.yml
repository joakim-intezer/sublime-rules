name: "Attachment: Microsoft image with QR code"
description: |
  Detects messages using Microsoft image based lures, referencing a QR code from an Unsolicited sender.
  These messages often lead users to phishing sites or initiate unwanted downloads upon scanning.
type: "rule"
severity: "medium"
source: "type.inbound\nand any(attachments, .file_type  in~ ('png', 'jpeg', 'jpg', 'bmp'))\nand any(attachments, \n        .file_type in~ ('bmp', 'png', 'jpg', 'jpeg')\n        and any(beta.logo_detect(.).brands, .name in~ (\"Microsoft\", \"Office365\"))\n)\nand any(attachments,\n    .file_type in~ ('bmp', 'png', 'jpg', 'jpeg')\n    and (\n        any(file.explode(.),\n            any(.scan.strings.strings, regex.icontains(.,  'scan|camera'))   \n            and any(.scan.strings.strings, regex.icontains(.,  '\\bQR\\b|Q\\.R\\.|barcode'))\n        )\n    )\n)\nand (\n    not any(headers.hops, .authentication_results.compauth.verdict is not null\n    and .authentication_results.compauth.verdict == \"pass\"\n    and sender.email.domain.domain == \"microsoft.com\")\n)\n// unsolicited\nand (\n    (\n        sender.email.domain.root_domain in $free_email_providers\n        and sender.email.email not in $recipient_emails\n    )\n    or (\n        sender.email.domain.root_domain not in $free_email_providers\n        and sender.email.domain.domain not in $recipient_domains\n    )\n)\n"
tags:
  - "Suspicious attachment"
  - "Brand impersonation"
  - "QR code"
testing_pr: 547
testing_sha: bb8126e20140a9b47fa89a3df7a0540fcd3293a9
